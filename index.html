<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学動画講座＆確認テスト</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { 
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            max-width: 500px; 
            margin: 0 auto; 
            padding: 10px; 
            text-align: center; 
            background-color: #f4f4f4; 
            color: #333;
            /* 横揺れアニメーション用 */
            overflow-x: hidden; 
        }
        
        /* --- 動画エリア --- */
        #video-section {
            width: 100%;
            margin-bottom: 15px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: block;
        }

        .video-container { position: relative; width: 100%; aspect-ratio: 16 / 9; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        /* --- 切り替えボタン --- */
        .toggle-btn-area { margin-bottom: 20px; }
        .skip-btn, .show-video-btn {
            width: 100%; padding: 10px; border-radius: 8px; font-size: 0.9em; cursor: pointer; border: none;
            transition: opacity 0.2s;
        }
        .skip-btn { background: #666; color: #fff; }
        .show-video-btn { background: #fff; color: #007bff; border: 2px solid #007bff; display: none; font-weight: bold;}

        /* --- テストエリア --- */
        #quiz-container {
            background: #fff;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.1s; /* 不正解時の揺れ用 */
        }
        /* 不正解時に揺らすクラス */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        h3 { margin-top: 0; color: #444; font-size: 1.1em; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;}
        #question-area { font-size: 1.8em; margin-bottom: 20px; min-height: 50px;}
        
        .input-container {
            background: #fdfdfd;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 5px 12px;
            text-align: right; 
        }
        .input-container.active { border-color: #007bff; }

        #raw-input { font-size: 0.9em; color: #aaa; height: 1.2em; letter-spacing: 1px; margin-bottom: 2px;}
        #math-preview { font-size: 2em; height: 1.5em; color: #000; overflow-x: auto; overflow-y: hidden; white-space: nowrap;}

        /* --- 解説エリア --- */
        #result-box {
            display: none; 
            text-align: left;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .res-correct { background-color: #f6ffed; border: 1px solid #b7eb8f; }
        .res-correct .res-header { color: #52c41a; }

        .res-wrong { background-color: #fff1f0; border: 1px solid #ffccc7; }
        .res-wrong .res-header { color: #f5222d; }

        .res-header { font-weight: bold; font-size: 1.2em; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .res-body { font-size: 0.95em; line-height: 1.6; color: #444; }
        .res-ans-label { font-size: 0.85em; color: #666; margin-top: 10px; display: block; border-top: 1px dashed #ccc; padding-top: 8px;}
        .res-correct-math { font-size: 1.4em; color: #d32f2f; margin-left: 5px; }

        /* --- キーパッド --- */
        #keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .key-btn {
            padding: 14px 0; font-size: 1.4em; border: none; border-radius: 8px;
            background-color: #f0f2f5; box-shadow: 0 4px #ced0d4; color: #333; cursor: pointer; touch-action: manipulation; transition: all 0.1s;
        }
        .key-btn:active { box-shadow: 0 2px #b0b3b8; transform: translateY(2px); }
        .btn-num { background-color: #fff; font-weight: bold; font-family: sans-serif; }
        .btn-op { background-color: #e4e6eb; font-weight: bold;} 
        .btn-blue { background-color: #e7f5ff; color: #007bff; font-family: sans-serif; box-shadow: 0 4px #badbeb;}
        .btn-red { background-color: #ffeef0; color: #d32f2f; font-family: sans-serif; box-shadow: 0 4px #f5c2c7;}
        .grid-span-2 { grid-column: span 2; }
        
        #next-btn {
            margin-top: 15px; padding: 12px 30px; font-size: 1.1em; background: #333; color: #fff; border: none; border-radius: 50px; cursor: pointer; width: 100%; display: none;
        }
    </style>
</head>
<body>

    <div id="video-section">
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/gHjJ_G-N_nU?si=dummy" title="Lecture Video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>

    <div class="toggle-btn-area">
        <button id="skip-btn" class="skip-btn" onclick="toggleVideo(false)">▼ 動画を閉じてテストへ</button>
        <button id="show-btn" class="show-video-btn" onclick="toggleVideo(true)">▲ 動画講義をもう一度見る</button>
    </div>

    <div id="quiz-container">
        <h3>確認テスト：第 <span id="q-number">1</span> 問</h3>
        
        <div id="question-area"></div>

        <div class="input-container" id="input-box">
            <div id="raw-input">答えを入力</div>
            <div id="math-preview"></div>
        </div>

        <div id="result-box"></div>

        <div id="keypad">
            <button class="key-btn btn-num" onclick="inputKey('7')">7</button>
            <button class="key-btn btn-num" onclick="inputKey('8')">8</button>
            <button class="key-btn btn-num" onclick="inputKey('9')">9</button>
            <button class="key-btn btn-red" onclick="deleteLast()">BS</button>
            <button class="key-btn btn-num" onclick="inputKey('4')">4</button>
            <button class="key-btn btn-num" onclick="inputKey('5')">5</button>
            <button class="key-btn btn-num" onclick="inputKey('6')">6</button>
            <button class="key-btn btn-op" onclick="inputKey('/')">/分</button> 
            <button class="key-btn btn-num" onclick="inputKey('1')">1</button>
            <button class="key-btn btn-num" onclick="inputKey('2')">2</button>
            <button class="key-btn btn-num" onclick="inputKey('3')">3</button>
            <button class="key-btn btn-op" onclick="inputKey('√')">√</button> 
            <button class="key-btn btn-num" onclick="inputKey('0')">0</button>
            <button class="key-btn btn-op" onclick="inputKey('π')">π</button>
            <button class="key-btn btn-op" onclick="inputKey('-')">-</button>
            <button class="key-btn btn-blue" onclick="submitAnswer()">決定</button>
        </div>

        <button id="next-btn" onclick="nextQuestion()">次の問題へ</button>
    </div>

    <script>
        function toggleVideo(show) {
            const videoSection = document.getElementById('video-section');
            const skipBtn = document.getElementById('skip-btn');
            const showBtn = document.getElementById('show-btn');
            if (show) {
                videoSection.style.display = 'block';
                skipBtn.style.display = 'inline-block';
                showBtn.style.display = 'none';
            } else {
                videoSection.style.display = 'none';
                skipBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
            }
        }

        // --- ★音を鳴らす魔法の関数（Web Audio API） ---
        // 外部ファイル不要で、コードだけで「ピンポン」「ブブー」を作ります
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'correct') {
                // ピンポン♪（高めのド→ソ）
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1046.5, audioCtx.currentTime); // C6
                osc.frequency.exponentialRampToValueAtTime(1567.9, audioCtx.currentTime + 0.1); // G6
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.6);
            } else {
                // ブブー…（低いノコギリ波）
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        let quizSet = [];
        let currentIndex = 0;
        let currentInput = "";

        const sampleQuestions = [
            { question: "\\text{半径}3\\text{cmの円の周の長さ}", correct_answer: "6π", explanation: "円周の公式は $2\\pi r$ です。<br>半径が3なので、$2 \\times \\pi \\times 3 = 6\\pi$ となります。" },
            { question: "\\sqrt{3} \\times \\sqrt{12}", correct_answer: "6", explanation: "$\\sqrt{3 \\times 12} = \\sqrt{36} = 6$ です。" },
            { question: "1 \\div 3", correct_answer: "1/3", explanation: "割り切れない場合は分数で表します。<br> $1 \\div 3 = \\frac{1}{3}$ です。" }
        ];

        document.addEventListener("DOMContentLoaded", () => {
            quizSet = sampleQuestions; 
            showQuestion();
        });

        function showQuestion() {
            const qData = quizSet[currentIndex];
            document.getElementById('q-number').innerText = currentIndex + 1;
            const resultBox = document.getElementById('result-box');
            resultBox.style.display = "none";
            resultBox.className = "";
            document.getElementById('next-btn').style.display = "none";
            document.getElementById('keypad').style.pointerEvents = "auto";
            document.getElementById('keypad').style.opacity = "1";
            document.getElementById('input-box').classList.add('active'); 
            
            // 揺れクラスがあれば消す
            document.getElementById('quiz-container').classList.remove('shake');

            currentInput = "";
            updateDisplay();
            katex.render(qData.question, document.getElementById('question-area'), { displayMode: true });
        }

        function inputKey(char) {
            if(currentInput.length > 10) return;
            currentInput += char;
            updateDisplay();
        }

        function deleteLast() {
            currentInput = currentInput.slice(0, -1);
            updateDisplay();
        }

        function updateDisplay() {
            const rawDisplay = document.getElementById('raw-input');
            const previewDisplay = document.getElementById('math-preview');
            rawDisplay.innerText = currentInput === "" ? "答えを入力" : currentInput;
            if (currentInput === "") {
                previewDisplay.innerText = "";
                return;
            }
            let texString = parseInputToTex(currentInput);
            try {
                katex.render(texString, previewDisplay, { throwOnError: false });
            } catch (e) {
                previewDisplay.innerText = currentInput;
            }
        }

        function parseInputToTex(input) {
            let tex = input;
            tex = tex.replace(/π/g, "\\pi");
            tex = tex.replace(/√(\d+)/g, "\\sqrt{$1}");
            tex = tex.replace(/([0-9π]+)\/([0-9π]+)/g, "\\frac{$1}{$2}");
            return tex;
        }

        function submitAnswer() {
            if(currentInput === "") return;
            
            const qData = quizSet[currentIndex];
            const resultBox = document.getElementById('result-box');
            
            document.getElementById('keypad').style.pointerEvents = "none";
            document.getElementById('keypad').style.opacity = "0.5";
            document.getElementById('input-box').classList.remove('active'); 
            
            const isCorrect = (currentInput === qData.correct_answer);
            let contentHTML = "";

            if (isCorrect) {
                // --- ★正解時のエフェクト ---
                playSound('correct'); // 音を鳴らす
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                }); // 紙吹雪発射！

                resultBox.className = "res-correct";
                contentHTML = `<div class="res-header">✅ 正解！</div><div class="res-body">${qData.explanation}</div>`;
            } else {
                // --- ★不正解時のエフェクト ---
                playSound('wrong'); // 音を鳴らす
                document.getElementById('quiz-container').classList.add('shake'); // 画面をブルブル揺らす

                let correctTex = parseInputToTex(qData.correct_answer);
                resultBox.className = "res-wrong";
                contentHTML = `<div class="res-header">❌ 残念...</div><div class="res-body">${qData.explanation}<span class="res-ans-label">正解は：<span class="res-correct-math" id="correct-display"></span></span></div>`;
            }

            resultBox.innerHTML = contentHTML;
            if (!isCorrect) {
                let correctTex = parseInputToTex(qData.correct_answer);
                katex.render(correctTex, document.getElementById('correct-display'));
            }

            // 解説文の数式レンダリング
            renderMathInElement(resultBox, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });

            resultBox.style.display = "block";
            document.getElementById('next-btn').style.display = "inline-block";
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < quizSet.length) {
                showQuestion();
            } else {
                // 全問正解時のグランドフィナーレ演出
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                playSound('correct');
                setTimeout(() => {
                    alert("全問終了！お疲れ様でした！");
                    location.reload();
                }, 1000);
            }
        }
    </script>
</body>
</html>